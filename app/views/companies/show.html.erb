
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<style type="text/css">
	.fixed-action-btn {
  float: right !important;
  position: absolute !important;
  right: 5px !important;
  top: 5px !important;
  }

  .sidenav-overlay{
    	opacity: 0 !important;
    }
  
</style>
<head>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
</head>
<%= render "layouts/header" %>

<div class="row">
    <div class="col s12">
      <ul class="tabs">
        <li class="tab col s3"><a class="active" href="#companykpis">KPI</a></li>
        <li class="tab col s3"><a href="#teamsid">Teams</a></li>
        <li class="tab col s3"><a href="#test3">Goals</a></li>
        <li class="tab col s3"><a href="#test4">Revenue Streams</a></li>
        <li class="tab col s3"><a href="#test4">Updates</a></li>
      </ul>
    </div>
    <div id="companykpis" class="col s12">
    	<div class="row">
    		<h5><%=@company.name%> <a class="btn" href="/kpis/new">Add Company Kpi</a></h5>
    	</div>
    	<% if @company.kpis %>
    		<div class="section">
	    		<%@company.kpis.each do |kpi|%>
	    			<%if kpi.metrics.exists?%>	    			
		    			<script type="text/javascript">
		    				google.charts.load('current', {packages: ['corechart', 'line']});
		    				google.charts.setOnLoadCallback(drawBackgroundColor);

		    				function drawBackgroundColor() {
		    				      var data = new google.visualization.DataTable();
		    				      data.addColumn('date', 'Updated');
		    				      data.addColumn('number', 'Amount');

		    				      var mets = []
		    				      
			    				      <%kpi.metrics.each do |i|%>
			    				      		var v = [new Date(<%=i.created_at.year%>, <%=i.created_at.month%>, <%=i.created_at.day%>)]
			    				      		v.push(<%=i.metric%>)
			    				      		mets.push(v)
			    				      	<%end%>
		    				      data.addRows(mets)

		    				      var options = {
		    				        hAxis: {	    				          
		    				          gridlines: {
		    				          	color: 'transparent'
		    				          },
		    				          baselineColor: '#000000',
		    				          textStyle: {
		    				          	color: 'black'
		    				          }
		    				        },
		    				        vAxis: {	    				          
		    				          gridlines: {
		    				          	color: 'transparent'
		    				          },
		    				          baselineColor: '#000000',
		    				          textStyle: {
		    				          	color: 'black'
		    				          }
		    				        },
		    				        series: {
					                    0: { color: '#000000', lineWidth: 1 },
					                    1: { color: '#000000', lineWidth: 1 }
					                },
		    				        legend: 'none',
		    				        backgroundColor: '#ffffff'
		    				      };

		    				      var chart<%=kpi.id%> = new google.visualization.LineChart(document.getElementById('chart_div-<%=kpi.id%>'));
		    				      chart<%=kpi.id%>.draw(data, options);
		    				    }
		    			</script>
	    			<%end%>
				
					    <div class="col s6 m6">
					    	<%if kpi.current_actual != nil %>
					        		<%currprogress =  (kpi.current_actual.to_f/kpi.target.to_f)*100%>
					        	<%else%>
					        		<%currprogress =  0%>
					        	<%end%>
					      <div class="card light-grey">
					      	<a href="#" data-target="slide-out-<%=kpi.id%>" id="slide-trigger-<%=kpi.id%>" class="sidenav-trigger"><i class="material-icons">menu</i></a>

					      	<ul id="slide-out-<%=kpi.id%>" class="sidenav" style="position: absolute; display: inline-block; width: 200px; height: 100%;">
				      	      <li><a href="#!">First Sidebar Link</a></li>
				      	      <li><a href="#!">Second Sidebar Link</a></li>
					      	 </ul>
					      	    
					      	<script type="text/javascript">
					      		$(document).ready(function(){
						      		$('#slide-out-<%=kpi.id%>').hide();
						      		$('#slide-trigger-<%=kpi.id%>').click(function() {
						      			$("#slide-out-<%=kpi.id%>").show();
						      		});
						      		$('.sidenav-overlay').click(function() {
						      			$("#slide-out-<%=kpi.id%>").hide();
						      		});
						      		
					      		});

					      	</script>
							      	


					      	<span class="dark-grey-text">
					      	<div class="card-content">
					      		<div class="row center-align">	
					      			
					      			

				        			<div class="row">
					        			<h5><%=kpi.target%> <%=kpi.name%> (<%=kpi.unit%>)</h5>		      				
					      				<p>From <%=kpi.target_start_date.to_formatted_s(:long)%> To <%=kpi.target_end_date.to_formatted_s(:long)%></p>
				      			    </div>
				      			    <div class="row">
						      				
					      			  	<div class="progress grey lighten-3" style="height: 10px;">
					      			      <div class="determinate green lighten-3<%= 'red lighten-3' if kpi.target/2 > kpi.current_actual %>" style="width: <%=currprogress%>%;"></div>
					      			  	</div>
					      			  	<p style="font-weight: 500;"><%=currprogress.round(1)%>% to Goal - <%=(kpi.target_end_date - Date.today).to_i%> Days Remain</p>
				      			    </div>			      			  	
						      		<div class="row">
						      			<a class="btn-floating" href="<%=new_company_kpi_metric_path(@company, kpi)%>"><i class="large material-icons">add</i></a>
					        			<a class="btn-floating" href="<%=edit_company_kpi_path(@company, kpi)%>"><i class="large material-icons">edit</i></a>
					        			<%=link_to '<a class="btn-floating"><i class="large material-icons">delete</i></a>'.html_safe, company_kpi_path(@company, kpi), method: :delete %>
				        			</div>	
					      								      			
					      		</div>						        	
					        </div>
					        <%if kpi.metrics.exists?%>
						        <div class="card-tabs">
					              <ul class="tabs tabs-fixed-width">
					                <li class="tab"><a class="active" href="#graph-<%=kpi.id%>">Charted Progress</a></li>
					                <li class="tab"><a  href="#allmetrics-<%=kpi.id%>">All Updates</a></li>
					              </ul>
					            </div>



						        <div class="card-content">
						        	<div class="row" id="graph-<%=kpi.id%>">
							      		<div id="chart_div-<%=kpi.id%>"></div>
							      	</div>
							      	<div id="allmetrics-<%=kpi.id%>">
								      	<ul class="collection">
									      	<%kpi.metrics.order(created_at: :desc).each do |mt|%>
									      		<li class="collection-item">
									      			Last Updated to <strong><%=mt.metric%></strong> on <%=mt.created_at.to_formatted_s(:long)%>
									      			<%=link_to "Delete", company_kpi_metric_path(@company, kpi, mt), method: :delete %>
									      			
									      		</li>
									      	<%end%>
								      	</ul>
							      	</div>						        		
						        </div>
					        <%end%>
		
					        </span>
					      </div>
					    </div>
				<%end%>
			</div>
			<a class="waves-effect waves-light btn" href="<%=new_company_kpi_path(@company)%>">Add New</a>
    	<%else%>
    		
    	<%end%>
    </div>
    
    <div id="teamsid" class="col 12 s12">
    	<a class="waves-effect waves-light btn" href="/teams/new">Create Team</a>
	<%@company.teams.each do |t|%>
		<div class="col s12 m6">
		<ul class="collection with-header">
			<li class="collection-header"><h4><%=t.name%><%=link_to '<i class="material-icons tooltipped" data-position="bottom" data-tooltip="Add Member">add</i>'.html_safe,  new_member_path%></h4>
				<p><%=t.description%></p></li>
			<%t.members.each do |m|%>
				<li class="collection-item avatar">
			      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRW2de1DnoYMy2eAJkE7yonqrNijWzZwJHyji7xVCoLTotK2giw" alt="" class="circle">
			      <span class="title"><%=m.name%></span>
			      <p><%=m.role%>
			      </p>
			      <span class="secondary-content">
<!-- 			      <a href="members/<%=m.id%>/delete" ><i class="material-icons">delete</i></a>
 -->			      <%=link_to '<i class="material-icons tooltipped" data-position="bottom" data-tooltip="Delete Kpi">delete</i>
			      	'.html_safe, member_path(m), method: :delete %>
			      <a href="#!"><i class="material-icons">arrow_forward</i></a>
			      </span>
			    </li>
			<%end%>
		  </ul>
		</div>
	<%end%>
</div>
    
    <div id="test3" class="col s12">

    </div>
    <div id="test4" class="col s12">Test 4</div>
  </div>

  <%= render "layouts/footer" %>
  <script language="javascript">
   $('.button-collapse').sideNav({
      menuWidth: 300, // Default is 240
      closeOnClick: true,
  // Closes side-nav on <a> clicks, useful for Angular/Meteor
    }
  );
  $('.collapsible').collapsible();
 </script>